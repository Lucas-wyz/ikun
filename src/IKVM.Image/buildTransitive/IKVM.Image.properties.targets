<Project>
    <PropertyGroup>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    </PropertyGroup>

    <PropertyGroup>
        <IkvmImageTargetPath Condition=" '$(IkvmImageTargetPath)' == '' ">ikvm</IkvmImageTargetPath>
        <IkvmPropertiesFileName Condition=" '$(IkvmPropertiesFileName)' == '' ">ikvm.properties</IkvmPropertiesFileName>
        <CopyIkvmImageItemToOutputDirectory Condition=" '$(CopyIkvmImageItemToOutputDirectory)' == '' ">PreserveNewest</CopyIkvmImageItemToOutputDirectory>
        <CopyIkvmImageItemToPublishDirectory Condition=" '$(CopyIkvmImageItemToPublishDirectory)' == '' "></CopyIkvmImageItemToPublishDirectory>
        <CopyIkvmPropertiesFileToOutputDirectory Condition=" '$(CopyIkvmPropertiesFileToOutputDirectory)' == '' ">PreserveNewest</CopyIkvmPropertiesFileToOutputDirectory>
        <CopyIkvmPropertiesFileToPublishDirectory Condition=" '$(CopyIkvmPropertiesFileToPublishDirectory)' == '' "></CopyIkvmPropertiesFileToPublishDirectory>
    </PropertyGroup>

    <Target Name="WriteIkvmPropertiesFile">
        <ItemGroup>
            <_IkvmPropertiesFileLine Include="ikvm.home.root=$(IkvmImageTargetPath)" />
        </ItemGroup>
        <MakeDir Directories="$(IntermediateOutputPath)" Condition="!Exists('$(IntermediateOutputPath)')" />
        <WriteLinesToFile Lines="@(_IkvmPropertiesFileLine)" File="$(IntermediateOutputPath)$(IkvmPropertiesFileName)" Overwrite="true" WriteOnlyWhenDifferent="true" />
    </Target>

    <Target Name="IncludeIkvmPropertiesFile" DependsOnTargets="WriteIkvmPropertiesFile" BeforeTargets="_GetPackageFiles;AssignLinkMetadata;AssignTargetPaths">
        <ItemGroup>
            <None Include="$(IntermediateOutputPath)$(IkvmPropertiesFileName)" Condition="Exists('$(IntermediateOutputPath)$(IkvmPropertiesFileName)')">
                <CopyToOutputDirectory>$(CopyIkvmPropertiesFileToOutputDirectory)</CopyToOutputDirectory>
                <CopyToPublishDirectory>$(CopyIkvmPropertiesFileToPublishDirectory)</CopyToPublishDirectory>
                <TargetPath>$(IkvmPropertiesFileName)</TargetPath>
                <Link>$(IkvmPropertiesFileName)</Link>
                <Pack>false</Pack>
            </None>
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <AssignTargetPathsDependsOn>
            WriteIkvmPropertiesFile;
            IncludeIkvmPropertiesFile;
            $(AssignTargetPathsDependsOn);
        </AssignTargetPathsDependsOn>
    </PropertyGroup>

</Project>
